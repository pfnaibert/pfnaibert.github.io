---
title: "Scraping Brazilian GDP data from the SIDRA-IBGE website"
description: "Scraping Brazilian GDP data from the SIDRA-IBGE website"
categories:
  - R
  - scrape
  - PIB
  - GDP
author:
  - name: "Paulo Ferreira Naibert"
    url: https://github.com/pfnaibert/
repository_url: https://github.com/pfnaibert/pfnaibert.github.io
draft: true
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_chunk$set(fig.width=8, fig.height=4)
```

https://www.jfcostasantos.com/post/2015-07-23-r-rmarkdown/

https://cran.r-project.org/web/packages/sidrar/index.html

Source code for the functions can be found [here](https://github.com/pfnaibert/pfnaibert.github.io/tree/master/R).

In this post, we will scrape the brazilian gdp data from the [SIDRA-IBGE](https://sidra.ibge.gov.br/) website.
First, let's load up our functions.

```{r}
library(dplyr)
library(reshape2)
library(lubridate)
library(xts)
library(dygraphs)
library(ggplot2)
library(ggthemes)
```

```{r}
ls()
source("../../R/funs-macro.R")
```

The `gdp.dl()` function, downloads the data from the website and saves a `.csv`.
The `gdp.transform()` loads the `.csv` file, transforms the data, renames the dates, makes a `data.frame` with the data, adds more transformed data, and finally saves the `data.frame` as a `.rds` file.

```{r, eval=F}
# download gdp
gdp.dl()

# transform gdp
gdp.transform()
```

After using the `gdp.dl()` and `gdp.transform()` functions, all we have to do is load the data and make our tables and graphs.

```{r}
# load gdp.df
gdp.df  <- gdp.load.df()

# load gdp.xts
gdp.xts <- gdp.load.xts()

# show gdp.df
paged_table(gdp.df)
```

Firs, let's make a table with the annual gdp data.

```{r}
tmp <- filter(gdp.df, dates > "2014-01-01" & month(dates) == "12" )
mat <- cbind( "Billions of current BRL"=tmp$sum4.nomi/1000, "Billions of 1995 BRL"=tmp$sum4.real/1000, "AC 4Q T/T-4"=tmp$ret.ac4q.real)
rownames(mat) <- substring( rownames(tmp), 1, 4)
kable( t( apply( mat, 2, rev) ), digits=2, caption = "GDP by Year")


```

Our last year's GDP was `r round(gdp.xts$sum4.nomi["2019-12"]/10^6, 2)` Trillions of BRL.

Now, let's make a table with this year's and the last years's quarterly gdp data.

```{r}
tmp <- filter(gdp.df, dates > "2019-01-01" )
mat <- cbind( "Billions of current BRL"=tmp$nominal/1000, "T/T-1"=tmp$ret1, "T/T-4"=tmp$ret4, "AC 4Q T/T-4"=tmp$ret.ac4q.real)
rownames(mat) <- rownames(tmp)
kable( t( apply( mat, 2, rev) ), digits=2, caption = "GDP by Quarter")
```

Graph of GDP in current BRL, I don't know why, but we can make it.

```{r}
ggplot(gdp.df) +
    geom_line( aes( x = dates, y = nominal/1000 ), color = "blue", size=1 ) +
    theme( plot.title = element_text(hjust = 0.5, face = "bold" ) ) +
    ggtitle( "GDP in Billions of Current BRL" ) +
    xlab("") + ylab("") +
	theme_economist()
```

Graph of GDP in chained 1995 BRL, seasonally adjusted and not seasonally adjusted.

```{r}
ggplot(gdp.df) +
    geom_line( aes( x = dates, y = real.SA/1000 ), color = "blue", size=1 ) +
    geom_line( aes( x = dates, y = real.NSA/1000 ), color = "red", size=1 ) +
    theme( plot.title = element_text(hjust = 0.5, face = "bold" ) ) +
    ggtitle( "GDP in Billions of 1995 Chained BRL" ) +
    xlab("") + ylab("") +
	theme_economist()
```

Graph of GDP percent change.

```{r}
tmp <- gdp.df %>%
filter(dates > "2014-01-01") %>%
select(dates, ret1, ret4, ret.ac4q.real)
tmp


tmp <- melt(tmp, "dates"); tmp


tmp %>%
ggplot( aes( x = dates, y = value, fill = variable) ) +
geom_bar( stat="identity", position="dodge" ) +
scale_fill_discrete(name=" ",
					breaks=c("ret1", "ret4", "ret.ac4q.real"),
					labels=c("T/T-1", "T/T-4", "T/T-4 AC4Q") ) +
xlab("") + ylab("") +
ggtitle( "Brazilian GDP %Change" ) +
theme( plot.title = element_text(hjust = 0.5, face = "bold" ) ) +
theme_economist()
```


# xts and dygraphs


```{r}
tmp <- gdp.xts$nominal/1000

dygraph(tmp, main="GDP in Billions of Current BRL") %>%
dyAxis("x", drawGrid = FALSE) %>%
dyEvent("2002-01-1", "Lula",  labelLoc = "bottom") %>%
dyEvent("2010-01-1", "Dilma", labelLoc = "bottom") %>%
dyEvent("2016-09-1", "Temer", labelLoc = "bottom") %>%
dyEvent("2019-01-1", "Bolsonaro", labelLoc = "bottom") %>%
dyEvent("2008-10-1", "Subprime", labelLoc = "bottom", color="red") %>%
dyEvent("2020-03-01", "Corona", labelLoc = "bottom", color="red")
```

```{r}
tmp <- cbind(gdp.xts$real.SA/1000, gdp.xts$real.NSA/1000)

dygraph(tmp, main="GDP in Billions of 1995 Chained BRL") %>%
dyAxis("x", drawGrid = FALSE) %>%
dyEvent("2002-01-1", "Lula",  labelLoc = "bottom") %>%
dyEvent("2010-01-1", "Dilma", labelLoc = "bottom") %>%
dyEvent("2016-09-1", "Temer", labelLoc = "bottom") %>%
dyEvent("2019-01-1", "Bolsonaro", labelLoc = "bottom") %>%
dyEvent("2008-10-1", "Subprime", labelLoc = "bottom", color="red") %>%
dyEvent("2020-03-01", "Corona", labelLoc = "bottom", color="red") %>%
dyLimit( max(tmp), "Peak", labelLoc = "left", color="blue" ) %>%
dySeries("real.NSA", label = "NSA") %>%
dySeries("real.SA", label = "SA")
```

```{r}
tmp <- gdp.xts["2014/"]
dygraph(cbind(tmp$ret1, tmp$ret4, tmp$ret.ac4q.real),
	   	main="Brazilian GDP %Change") %>%
dySeries("ret1", label = "T/T-1") %>%
dySeries("ret4", label = "T/T-4") %>%
dySeries("ret.ac4q.real", label = "AC 4Q T/T-4") %>%
dyBarChart() %>%
dyAxis("x", drawGrid = FALSE)
```
